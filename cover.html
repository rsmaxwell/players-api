
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/rsmaxwell/players-api/main.go (48.9%)</option>
				
				<option value="file1">github.com/rsmaxwell/players-api/players/people.go (75.4%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">no coverage</span>
				<span class="cov1">low coverage</span>
				<span class="cov2">*</span>
				<span class="cov3">*</span>
				<span class="cov4">*</span>
				<span class="cov5">*</span>
				<span class="cov6">*</span>
				<span class="cov7">*</span>
				<span class="cov8">*</span>
				<span class="cov9">*</span>
				<span class="cov10">high coverage</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package main

import (
        "encoding/json"
        "fmt"
        "io"
        "io/ioutil"
        "net/http"
        "os"
        "strconv"

        "github.com/gorilla/mux"

        "github.com/rsmaxwell/players-api/logger"
        "github.com/rsmaxwell/players-api/players"
)

var (
        port                      int
        username                  string
        password                  string
        baseURL                   string
        clientSuccess             int
        clientError               int
        clientAuthenticationError int
        serverError               int
)

// Authenticate Response JSON object
type authenticateResponseJSON struct {
        Token string `json:"token"`
}

// Error Response JSON object
type messageResponseJSON struct {
        Message string `json:"message"`
}

// metrics Response JSON object
type metricsResponseJSON struct {
        ClientSuccess             int `json:"clientSuccess"`
        ClientError               int `json:"clientError"`
        ClientAuthenticationError int `json:"clientAuthenticationError"`
        ServerError               int `json:"serverError"`
}

// People details Response JSON object
type personDetailsResponseJSON struct {
        Person players.Person `json:"person"`
}

// List people Response JSON object
type listPeopleResponseJSON struct {
        People []int `json:"people"`
}

// Number of people Response JSON object
type numberOfPeopleResponseJSON struct {
        NumberOfPeople int `json:"numberOfPeople"`
}

// Handle writing error messager response.
func writeMessageResponse(w http.ResponseWriter, httpStatus int, message string) <span class="cov8" title="9">{
        logger.Logger.Printf("Response: %d %s - %s", httpStatus, http.StatusText(httpStatus), message)
        w.Header().Set("Content-Type", "application/json")
        w.WriteHeader(httpStatus)

        json.NewEncoder(w).Encode(messageResponseJSON{
                Message: message,
        })
}</span>

func setHeaders(rw http.ResponseWriter, req *http.Request) <span class="cov7" title="7">{
        origin := req.Header.Get("Origin")

        if origin == "" </span><span class="cov7" title="7">{
                origin = "http://localhost:4200"
        }</span>

        <span class="cov7" title="7">rw.Header().Set("Content-Type", "application/json")
        rw.Header().Set("Access-Control-Allow-Origin", origin)
        rw.Header().Set("Access-Control-Allow-Methods", "POST, GET, OPTIONS, PUT, DELETE")
        rw.Header().Set("Access-Control-Allow-Headers",
                "Accept, Content-Type, Content-Length, Accept-Encoding, X-CSRF-Token, Access-Control-Allow-Origin, Authorization")</span>
}

// Handle authenticate response
func writeAuthenticateResponse(rw http.ResponseWriter, req *http.Request) <span class="cov0" title="0">{

        logger.Logger.Printf("writeAuthenticateResponse")

        // Check the user calling the service
        user, pass, _ := req.BasicAuth()

        if !checkUser(user, pass) </span><span class="cov0" title="0">{
                writeMessageResponse(rw, http.StatusUnauthorized, "Invalid username and/or password")
                clientError++
                clientAuthenticationError++
                return
        }</span>

        <span class="cov0" title="0">token := "qwerty"

        rw.WriteHeader(http.StatusOK)
        json.NewEncoder(rw).Encode(authenticateResponseJSON{
                Token: token,
        })</span>
}

// Handle Users - getAll
func writeUsersGetAllResponse(rw http.ResponseWriter, req *http.Request) <span class="cov0" title="0">{

        logger.Logger.Printf("writeUsersgetAllResponse")

        // Check the user calling the service
        user, pass, _ := req.BasicAuth()

        if !checkUser(user, pass) </span><span class="cov0" title="0">{
                writeMessageResponse(rw, http.StatusUnauthorized, "Invalid username and/or password")
                clientError++
                clientAuthenticationError++
                return
        }</span>

        <span class="cov0" title="0">rw.WriteHeader(http.StatusOK)</span>
}

// Handle Users - get by Id
func writeUsersGetByIDResponse(rw http.ResponseWriter, req *http.Request, id string) <span class="cov0" title="0">{

        logger.Logger.Printf("writeUsersGetByIdResponse")

        // Check the user calling the service
        user, pass, _ := req.BasicAuth()

        if !checkUser(user, pass) </span><span class="cov0" title="0">{
                writeMessageResponse(rw, http.StatusUnauthorized, "Invalid username and/or password")
                clientError++
                clientAuthenticationError++
                return
        }</span>

        <span class="cov0" title="0">rw.WriteHeader(http.StatusOK)</span>
}

// Handle Users - create
func writeUsersCreateResponse(rw http.ResponseWriter, req *http.Request) <span class="cov0" title="0">{

        logger.Logger.Printf("writeUsersCreateResponse")

        // Check the user calling the service
        user, pass, _ := req.BasicAuth()

        if !checkUser(user, pass) </span><span class="cov0" title="0">{
                writeMessageResponse(rw, http.StatusUnauthorized, "Invalid username and/or password")
                clientError++
                clientAuthenticationError++
                return
        }</span>

        <span class="cov0" title="0">rw.WriteHeader(http.StatusOK)</span>
}

// Handle Users - update
func writeUsersUpdateResponse(rw http.ResponseWriter, req *http.Request) <span class="cov0" title="0">{

        logger.Logger.Printf("writeUsersUpdateResponse")

        // Check the user calling the service
        user, pass, _ := req.BasicAuth()

        if !checkUser(user, pass) </span><span class="cov0" title="0">{
                writeMessageResponse(rw, http.StatusUnauthorized, "Invalid username and/or password")
                clientError++
                clientAuthenticationError++
                return
        }</span>

        <span class="cov0" title="0">rw.WriteHeader(http.StatusOK)</span>
}

// Handle Users - delete
func writeUsersDeleteResponse(rw http.ResponseWriter, req *http.Request) <span class="cov0" title="0">{

        logger.Logger.Printf("writeUsersDeleteResponse")

        // Check the user calling the service
        user, pass, _ := req.BasicAuth()

        if !checkUser(user, pass) </span><span class="cov0" title="0">{
                writeMessageResponse(rw, http.StatusUnauthorized, "Invalid username and/or password")
                clientError++
                clientAuthenticationError++
                return
        }</span>

        <span class="cov0" title="0">rw.WriteHeader(http.StatusOK)</span>
}

// Handle writing person info response
func writePersonInfoResponse(rw http.ResponseWriter, req *http.Request) <span class="cov3" title="2">{
        // Check the user calling the service
        user, pass, _ := req.BasicAuth()

        if !checkUser(user, pass) </span><span class="cov1" title="1">{
                writeMessageResponse(rw, http.StatusUnauthorized, "Invalid username and/or password")
                clientError++
                clientAuthenticationError++
                return
        }</span>

        <span class="cov1" title="1">listOfPeople, err := players.List()
        if err != nil </span><span class="cov0" title="0">{
                writeMessageResponse(rw, http.StatusInternalServerError, "Error getting list of people")
                serverError++
                return
        }</span>

        <span class="cov1" title="1">numberOfPeople := len(listOfPeople)

        setHeaders(rw, req)

        rw.WriteHeader(http.StatusOK)
        json.NewEncoder(rw).Encode(numberOfPeopleResponseJSON{
                NumberOfPeople: numberOfPeople,
        })</span>
}

// Handle PreflightRequest
func writePreflightRequest(rw http.ResponseWriter, req *http.Request) <span class="cov0" title="0">{
        setHeaders(rw, req)
        rw.WriteHeader(http.StatusOK)
}</span>

// Handle writing the GET list of People response
func writeGetListOfPeopleResponse(rw http.ResponseWriter, req *http.Request) <span class="cov3" title="2">{

        setHeaders(rw, req)

        user, pass, _ := req.BasicAuth()

        if !checkUser(user, pass) </span><span class="cov1" title="1">{
                writeMessageResponse(rw, http.StatusUnauthorized, "Invalid username and/or password")
                clientError++
                clientAuthenticationError++
                return
        }</span>

        <span class="cov1" title="1">listOfPeople, err := players.List()
        if err != nil </span><span class="cov0" title="0">{
                writeMessageResponse(rw, http.StatusInternalServerError, "Error getting list of people")
                serverError++
                return
        }</span>

        <span class="cov1" title="1">rw.WriteHeader(http.StatusOK)
        json.NewEncoder(rw).Encode(listPeopleResponseJSON{
                People: listOfPeople,
        })</span>
}

// Write the GET person response
func writeGetPersonDetailsResponse(rw http.ResponseWriter, req *http.Request, idString string) <span class="cov3" title="2">{
        // Check the user calling the service
        user, pass, _ := req.BasicAuth()
        if !checkUser(user, pass) </span><span class="cov1" title="1">{
                writeMessageResponse(rw, http.StatusUnauthorized, "Invalid username and/or password")
                clientError++
                clientAuthenticationError++
                return
        }</span>

        <span class="cov1" title="1">id, err := strconv.Atoi(idString)
        if err != nil </span><span class="cov0" title="0">{
                writeMessageResponse(rw, http.StatusNotFound, "Not Found")
                clientError++
                return
        }</span>

        <span class="cov1" title="1">person, err := players.Details(id)

        if err != nil </span><span class="cov0" title="0">{
                writeMessageResponse(rw, http.StatusNotFound, "Not Found")
                clientError++
                return
        }</span>

        <span class="cov1" title="1">setHeaders(rw, req)

        rw.WriteHeader(http.StatusOK)
        json.NewEncoder(rw).Encode(personDetailsResponseJSON{
                Person: *person,
        })</span>
}

// Write the POST Add Person response
func writePostAddPersonResponse(rw http.ResponseWriter, req *http.Request) <span class="cov3" title="2">{
        // Check the user calling the service
        user, pass, _ := req.BasicAuth()
        if !checkUser(user, pass) </span><span class="cov1" title="1">{
                writeMessageResponse(rw, http.StatusUnauthorized, "Invalid username and/or password")
                clientError++
                clientAuthenticationError++
                return
        }</span>

        <span class="cov1" title="1">var p players.Person

        limitedReader := &amp;io.LimitedReader{R: req.Body, N: 20 * 1024}
        b, err := ioutil.ReadAll(limitedReader)
        if err != nil </span><span class="cov0" title="0">{
                writeMessageResponse(rw, http.StatusBadRequest, fmt.Sprintf("Too much data posted in Add Person request"))
                clientError++
                return
        }</span>

        <span class="cov1" title="1">err = json.Unmarshal(b, &amp;p)
        if err != nil </span><span class="cov0" title="0">{
                writeMessageResponse(rw, http.StatusBadRequest, fmt.Sprintf("Could not parse person data for Add Person request"))
                clientError++
                return
        }</span>

        <span class="cov1" title="1">err = players.AddPerson(p)
        if err != nil </span><span class="cov0" title="0">{
                writeMessageResponse(rw, http.StatusBadRequest, fmt.Sprintf("Could not create a new person. err:%s", err))
                serverError++
                return
        }</span>

        <span class="cov1" title="1">setHeaders(rw, req)

        writeMessageResponse(rw, http.StatusOK, "ok")</span>
}

// Write the DELETE person response
func writeDeletePersonResponse(rw http.ResponseWriter, req *http.Request, idString string) <span class="cov3" title="2">{
        // Check the user calling the service
        user, pass, _ := req.BasicAuth()
        if !checkUser(user, pass) </span><span class="cov1" title="1">{
                writeMessageResponse(rw, http.StatusUnauthorized, "Invalid username and/or password")
                clientError++
                clientAuthenticationError++
                return
        }</span>

        // Convert the ID into a number
        <span class="cov1" title="1">id, err := strconv.Atoi(idString)
        if err != nil </span><span class="cov0" title="0">{
                logger.Logger.Printf(err.Error())
                writeMessageResponse(rw, http.StatusBadRequest, fmt.Sprintf("The ID:%s is not a number", idString))
                clientError++
                return
        }</span>

        <span class="cov1" title="1">players.Delete(id)

        setHeaders(rw, req)

        writeMessageResponse(rw, http.StatusOK, "ok")</span>
}

// Write the GET metrics response
func writeGetMetricsResponse(rw http.ResponseWriter, req *http.Request) <span class="cov3" title="2">{
        // Check the user calling the service
        user, pass, _ := req.BasicAuth()
        if !checkUser(user, pass) </span><span class="cov1" title="1">{
                writeMessageResponse(rw, http.StatusUnauthorized, "Invalid username and/or password")
                clientError++
                clientAuthenticationError++
                return
        }</span>

        <span class="cov1" title="1">setHeaders(rw, req)

        rw.WriteHeader(http.StatusOK)
        json.NewEncoder(rw).Encode(metricsResponseJSON{
                ClientSuccess:             clientSuccess,
                ClientError:               clientError,
                ClientAuthenticationError: clientAuthenticationError,
                ServerError:               serverError,
        })</span>
}

// Handlers for REST API routes
func setupHandlers(r *mux.Router) <span class="cov9" title="12">{

        // Authenticate
        r.HandleFunc(baseURL+"/authenticate", logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov0" title="0">{
                        writeAuthenticateResponse(w, req)
                }</span>)).Methods(http.MethodPost)

        // Users - getAll
        <span class="cov9" title="12">r.HandleFunc(baseURL+"/users", logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov0" title="0">{
                        writeUsersGetAllResponse(w, req)
                }</span>)).Methods(http.MethodGet)

        // Users - getById
        <span class="cov9" title="12">r.HandleFunc(baseURL+"/users/{id}", logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov0" title="0">{
                        writeUsersGetByIDResponse(w, req, mux.Vars(req)["id"])
                }</span>)).Methods(http.MethodGet)

        // Users - create
        <span class="cov9" title="12">r.HandleFunc(baseURL+"/users", logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov0" title="0">{
                        writeUsersCreateResponse(w, req)
                }</span>)).Methods(http.MethodPost)

        // Users - update
        <span class="cov9" title="12">r.HandleFunc(baseURL+"/users", logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov0" title="0">{
                        writeUsersUpdateResponse(w, req)
                }</span>)).Methods(http.MethodPut)

        // Users - delete
        <span class="cov9" title="12">r.HandleFunc(baseURL+"/users", logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov0" title="0">{
                        writeUsersDeleteResponse(w, req)
                }</span>)).Methods(http.MethodDelete)

        // PersonInfo
        <span class="cov9" title="12">r.HandleFunc(baseURL+"/personinfo", logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov3" title="2">{
                        writePersonInfoResponse(w, req)
                }</span>)).Methods(http.MethodGet)

        // ListPeople
        <span class="cov9" title="12">r.HandleFunc(baseURL+"/people", logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov3" title="2">{
                        writeGetListOfPeopleResponse(w, req)
                }</span>)).Methods(http.MethodGet)

        <span class="cov9" title="12">r.HandleFunc(baseURL+"/people", logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov0" title="0">{
                        writePreflightRequest(w, req)
                }</span>)).Methods(http.MethodOptions)

        // Person Details
        <span class="cov9" title="12">r.HandleFunc(baseURL+"/person/{id}", logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov3" title="2">{
                        writeGetPersonDetailsResponse(w, req, mux.Vars(req)["id"])
                }</span>)).Methods(http.MethodGet)

        // Add Person
        <span class="cov9" title="12">r.HandleFunc(baseURL+"/person", logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov3" title="2">{
                        writePostAddPersonResponse(w, req)
                }</span>)).Methods(http.MethodPost)

        // Delete Person
        <span class="cov9" title="12">r.HandleFunc(baseURL+"/person/{id}", logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov3" title="2">{
                        writeDeletePersonResponse(w, req, mux.Vars(req)["id"])
                }</span>)).Methods(http.MethodDelete)

        // Metrics
        <span class="cov9" title="12">r.HandleFunc(baseURL+"/metrics", logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov3" title="2">{
                        writeGetMetricsResponse(w, req)
                }</span>)).Methods(http.MethodGet)

        // Not Found
        <span class="cov9" title="12">r.NotFoundHandler = http.HandlerFunc(logger.LogHandler(
                func(w http.ResponseWriter, req *http.Request) </span><span class="cov0" title="0">{
                        writeMessageResponse(w, http.StatusNotFound, "Not Found")
                        clientError++
                }</span>))
}

// Simple check on the user calling the service
func checkUser(u, p string) bool <span class="cov10" title="14">{

        if u != username </span><span class="cov7" title="7">{
                logger.Logger.Printf("checkUser: FAIL: username = %s, u = %s\n", username, u)
                return false
        }</span><span class="cov7" title="7"> else if p != password </span><span class="cov0" title="0">{
                logger.Logger.Printf("checkUser: FAIL: password = %s %s\n", password, p)
                return false
        }</span>

        <span class="cov7" title="7">logger.Logger.Printf("checkUser: OK\n")
        return true</span>
}

func main() <span class="cov0" title="0">{

        logger.Logger.Printf("Players Server: 2018-01-31 13:30")
        var ok bool

        username, ok = os.LookupEnv("USERNAME")
        if !ok </span><span class="cov0" title="0">{
                username = "foo"
        }</span>

        <span class="cov0" title="0">password, ok = os.LookupEnv("PASSWORD")
        if !ok </span><span class="cov0" title="0">{
                password = "bar"
        }</span>

        <span class="cov0" title="0">baseURL, ok = os.LookupEnv("BASEURL")
        if !ok </span><span class="cov0" title="0">{
                baseURL = ""
        }</span>

        <span class="cov0" title="0">portstring, ok := os.LookupEnv("PORT")
        if !ok </span><span class="cov0" title="0">{
                portstring = "4201"
        }</span>
        <span class="cov0" title="0">port, err := strconv.Atoi(portstring)
        if err != nil </span><span class="cov0" title="0">{
                logger.Logger.Fatalf(err.Error())
        }</span>

        <span class="cov0" title="0">logger.Logger.Printf("Registering Router and setting Handlers")
        router := mux.NewRouter()
        setupHandlers(router)

        logger.Logger.Printf("Username = %s, Password = %s", username, password)
        logger.Logger.Printf("Listening to base URL: '%s' port: %d", baseURL, port)
        err = http.ListenAndServe(fmt.Sprintf(":%d", port), router)
        if err != nil </span><span class="cov0" title="0">{
                logger.Logger.Fatalf(err.Error())
        }</span>

        <span class="cov0" title="0">logger.Logger.Printf("Success")</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package players

import (
        "encoding/json"
        "flag"
        "fmt"
        "io/ioutil"
        "log"
        "os"
        "path/filepath"
        "runtime"
        "strconv"

        "github.com/rsmaxwell/players-api/logger"
)

// Person Structure
type Person struct {
        Name string `json:"name"`
}

// Info structure
type Info struct {
        CurrentID int `json:"currentID"`
}

var (
        rootdir             string
        peopleDirectory     string
        peopleDataDirectory string
        peopleInfoFile      string
)

func homeDir() string <span class="cov1" title="1">{
        env := "HOME"
        if runtime.GOOS == "windows" </span><span class="cov0" title="0">{
                env = "USERPROFILE"
        }</span><span class="cov1" title="1"> else if runtime.GOOS == "plan9" </span><span class="cov0" title="0">{
                env = "home"
        }</span>
        <span class="cov1" title="1">return os.Getenv(env)</span>
}

func init() <span class="cov1" title="1">{

        home := homeDir()

        if flag.Lookup("test.v") == nil </span><span class="cov0" title="0">{
                rootdir = home + "/players-api"
        }</span><span class="cov1" title="1"> else {
                rootdir = home + "/players-api-test"
        }</span>

        <span class="cov1" title="1">peopleDirectory = rootdir + "/people"
        peopleDataDirectory = peopleDirectory + "/data"
        peopleInfoFile = peopleDirectory + "/info.json"

        logger.Logger.Printf("peopleDirectory = %s\n", peopleDirectory)</span>
}

func removeContents(dir string) error <span class="cov6" title="13">{
        d, err := os.Open(dir)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov6" title="13">defer d.Close()
        names, err := d.Readdirnames(-1)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov6" title="13">for _, name := range names </span><span class="cov7" title="25">{
                err = os.RemoveAll(filepath.Join(dir, name))
                if err != nil </span><span class="cov0" title="0">{
                        return err
                }</span>
        }
        <span class="cov6" title="13">return nil</span>
}

// CreatePeopleDirectory  creates the people directory
func CreatePeopleDirectory() error <span class="cov10" title="78">{

        _, err := os.Stat(peopleDirectory)
        if err != nil </span><span class="cov6" title="13">{
                err := os.MkdirAll(peopleDirectory, 0755)
                if err != nil </span><span class="cov0" title="0">{
                        return err
                }</span>
        }

        <span class="cov10" title="78">_, err = os.Stat(peopleDataDirectory)
        if err != nil </span><span class="cov6" title="13">{
                err := os.MkdirAll(peopleDataDirectory, 0755)
                if err != nil </span><span class="cov0" title="0">{
                        return err
                }</span>
        }

        <span class="cov10" title="78">return nil</span>
}

// RemovePeopleDirectory removes ALL the person files
func RemovePeopleDirectory() error <span class="cov6" title="14">{
        logger.Logger.Printf("Remove person directory")

        _, err := os.Stat(peopleDirectory)
        if err == nil </span><span class="cov6" title="13">{
                err := removeContents(peopleDirectory)
                if err != nil </span><span class="cov0" title="0">{
                        logger.Logger.Panic(err.Error())
                }</span>

                <span class="cov6" title="13">os.Remove(peopleDirectory)</span>
        }

        <span class="cov6" title="14">return nil</span>
}

// CreatePeopleInfoFile initialises the Info object from file
func CreatePeopleInfoFile() (*Info, error) <span class="cov8" title="33">{

        logger.Logger.Printf("Checking the infofile exists")
        if _, err := os.Stat(peopleInfoFile); os.IsNotExist(err) </span><span class="cov5" title="10">{

                err := CreatePeopleDirectory()
                if err != nil </span><span class="cov0" title="0">{
                        logger.Logger.Panicf(err.Error())
                }</span>

                <span class="cov5" title="10">info := Info{CurrentID: 1000}
                infoJSON, err := json.Marshal(info)
                if err != nil </span><span class="cov0" title="0">{
                        logger.Logger.Panicf(err.Error())
                }</span>

                <span class="cov5" title="10">err = ioutil.WriteFile(peopleInfoFile, infoJSON, 0644)
                if err != nil </span><span class="cov0" title="0">{
                        logger.Logger.Panicf(err.Error())
                }</span>
        }

        <span class="cov8" title="33">data, err := ioutil.ReadFile(peopleInfoFile)
        if err != nil </span><span class="cov1" title="1">{
                logger.Logger.Panicf(err.Error())
        }</span>

        <span class="cov8" title="32">var i Info
        err = json.Unmarshal(data, &amp;i)
        if err != nil </span><span class="cov2" title="2">{
                logger.Logger.Panicf(err.Error())
        }</span>

        <span class="cov8" title="30">return &amp;i, nil</span>
}

// GetAndIncrementCurrentID returns the CurrentID and then increments the CurrentID on disk
func GetAndIncrementCurrentID() (int, error) <span class="cov7" title="22">{

        // Make sure the person directory and info file exists
        _, err := CreatePeopleInfoFile()
        if err != nil </span><span class="cov0" title="0">{
                return 0, err
        }</span>

        // Read the person info file
        <span class="cov7" title="21">data, err := ioutil.ReadFile(peopleInfoFile)
        if err != nil </span><span class="cov0" title="0">{
                return 0, err
        }</span>

        <span class="cov7" title="21">var i Info
        err = json.Unmarshal(data, &amp;i)
        if err != nil </span><span class="cov0" title="0">{
                return 0, err
        }</span>

        <span class="cov7" title="21">currentID := i.CurrentID

        i.CurrentID = i.CurrentID + 1

        infoJSON, err := json.Marshal(i)
        if err != nil </span><span class="cov0" title="0">{
                return 0, err
        }</span>

        <span class="cov7" title="21">err = ioutil.WriteFile(peopleInfoFile, infoJSON, 0644)
        if err != nil </span><span class="cov0" title="0">{
                return 0, err
        }</span>

        <span class="cov7" title="21">return currentID, nil</span>
}

// NewPerson initialises a Person object
func NewPerson(name string) (*Person, error) <span class="cov5" title="10">{
        person := new(Person)
        person.Name = name
        return person, nil
}</span>

// AddPerson adds a person to the list of people
func AddPerson(person Person) error <span class="cov5" title="10">{

        err := CreatePeopleDirectory()
        if err != nil </span><span class="cov0" title="0">{
                log.Println(err)
                return err
        }</span>

        <span class="cov5" title="10">id, err := GetAndIncrementCurrentID()
        if err != nil </span><span class="cov0" title="0">{
                log.Println(err)
                return err
        }</span>

        <span class="cov5" title="10">personJSON, err := json.Marshal(person)
        if err != nil </span><span class="cov0" title="0">{
                logger.Logger.Print(err)
                return fmt.Errorf("internal error")
        }</span>

        <span class="cov5" title="10">err = CreatePeopleDirectory()
        if err != nil </span><span class="cov0" title="0">{
                logger.Logger.Panicf(err.Error())
        }</span>

        <span class="cov5" title="10">personfile := peopleDataDirectory + "/" + strconv.Itoa(id) + ".json"
        err = ioutil.WriteFile(personfile, personJSON, 0644)
        if err != nil </span><span class="cov0" title="0">{
                logger.Logger.Print(err)
                return fmt.Errorf("internal error")
        }</span>

        <span class="cov5" title="10">return nil</span>
}

// List returns a list of the person IDs
func List() ([]int, error) <span class="cov5" title="8">{

        err := CreatePeopleDirectory()
        if err != nil </span><span class="cov0" title="0">{
                log.Println(err)
                return nil, err
        }</span>

        <span class="cov5" title="8">files, err := ioutil.ReadDir(peopleDataDirectory)
        if err != nil </span><span class="cov0" title="0">{
                log.Println(err)
                return nil, err
        }</span>

        <span class="cov5" title="8">var list []int
        for _, filenameInfo := range files </span><span class="cov6" title="14">{
                var filename = filenameInfo.Name()
                var extension = filepath.Ext(filename)
                var name = filename[0 : len(filename)-len(extension)]

                id, err := strconv.Atoi(name)

                if err != nil </span><span class="cov2" title="2">{
                        logger.Logger.Printf("Skipping unexpected person filename \"%s\". err = %s\n", filename, err)
                }</span>

                <span class="cov6" title="14">list = append(list, id)</span>
        }

        <span class="cov5" title="8">return list, nil</span>
}

// Details returns the details of the person with the matching ID
func Details(id int) (*Person, error) <span class="cov7" title="27">{

        err := CreatePeopleDirectory()
        if err != nil </span><span class="cov0" title="0">{
                log.Println(err)
                return nil, err
        }</span>

        <span class="cov7" title="27">personfile := peopleDataDirectory + "/" + strconv.Itoa(id) + ".json"
        if _, err := os.Stat(personfile); os.IsNotExist(err) </span><span class="cov1" title="1">{
                logger.Logger.Printf("The person file was not found. err = %s\n", err)
                return nil, err
        }</span>

        <span class="cov7" title="26">data, err := ioutil.ReadFile(personfile)
        if err != nil </span><span class="cov0" title="0">{
                logger.Logger.Printf("Could not read file. err = %s\n", err)
                return nil, err
        }</span>

        <span class="cov7" title="26">var p Person
        err = json.Unmarshal(data, &amp;p)
        if err != nil </span><span class="cov1" title="1">{
                logger.Logger.Printf("Could not parse info data. err = %s\n", err)
                return nil, err
        }</span>
        <span class="cov7" title="25">return &amp;p, nil</span>
}

// Delete the person with the matching ID
func Delete(id int) error <span class="cov4" title="6">{

        err := CreatePeopleDirectory()
        if err != nil </span><span class="cov0" title="0">{
                log.Println(err)
                return err
        }</span>

        <span class="cov4" title="6">personfile := peopleDataDirectory + "/" + strconv.Itoa(id) + ".json"
        _, err = os.Stat(personfile)
        if err != nil </span><span class="cov1" title="1">{
                logger.Logger.Print(err)
                return fmt.Errorf("person [%d] not found", id)
        }</span>

        <span class="cov4" title="5">err = os.Remove(personfile)
        if err != nil </span><span class="cov0" title="0">{
                logger.Logger.Print(err)
                return fmt.Errorf("could not delete person [%d]", id)
        }</span>

        <span class="cov4" title="5">return nil</span>
}

// Reset resets the list of people
func Reset(names ...string) error <span class="cov4" title="5">{

        err := RemovePeopleDirectory()
        if err != nil </span><span class="cov0" title="0">{
                logger.Logger.Fatal(err)
        }</span>

        <span class="cov4" title="5">err = CreatePeopleDirectory()
        if err != nil </span><span class="cov0" title="0">{
                logger.Logger.Fatal(err)
        }</span>

        <span class="cov4" title="5">_, err = CreatePeopleInfoFile()
        if err != nil </span><span class="cov0" title="0">{
                logger.Logger.Fatal(err)
        }</span>

        <span class="cov4" title="5">for _, element := range names </span><span class="cov3" title="4">{
                person, err := NewPerson(element)
                if err != nil </span><span class="cov0" title="0">{
                        logger.Logger.Fatal(err)
                }</span>

                <span class="cov3" title="4">err = AddPerson(*person)
                if err != nil </span><span class="cov0" title="0">{
                        logger.Logger.Fatal(err)
                }</span>
        }

        <span class="cov4" title="5">return nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
